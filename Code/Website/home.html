<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Visualizing Mortality Patterns in the U.S. (2018–2024)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-2.24.2.min.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .hero { padding: 28px 0; }
    .controls { gap: 12px; display: flex; flex-wrap: wrap; align-items: center; }
    .chart { min-height: 360px; margin-bottom: 24px; }
    @media (max-width: 768px) { .controls { flex-direction: column; align-items: stretch; } }
    .note { font-size: 0.9rem; color: #444; }
  </style>
</head>
<body>
  <div class="container py-4">
    <!-- Header -->
    <header class="hero mb-4">
      <h1 class="mb-2">Visualizing Mortality Patterns in the U.S.<br><small class="text-muted">Trends by Cause, Demographics, and Urbanization (2018–2024)</small></h1>
      <p class="mb-1"><strong>Author:</strong> Khaleesi Chen</p>
      <p class="lead">Understanding how mortality patterns differ across regions, races, and causes of death offers essential insights into public health disparities and emerging threats. This site presents interactive, multi-level visualizations built from CDC WONDER provisional mortality data.</p>
    </header>

    <!-- Project Goal -->
    <section class="mb-4">
      <h2 class="h4">Project Goal</h2>
      <p>Explore questions like: <strong>How have mortality rates from key causes (COVID-19, heart disease, drug overdoses) changed since 2018?</strong> How do trends vary by race, age, geography, and urbanization?</p>
    </section>

    <!-- Dataset Info -->
    <section class="mb-4">
      <h2 class="h4">Dataset</h2>
      <p class="note">Data source: CDC WONDER provisional multiple cause of death, 2018–2024. All visualizations use the latest available data.</p>
    </section>

    <!-- Controls -->
    <section class="mb-4">
      <div class="row g-4 mb-4 align-items-stretch">
        <div class="col-lg-3 col-md-6 mb-3">
          <div class="card shadow h-100 border-0 bg-gradient" style="background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);">
            <div class="card-body text-center">
              <h5 class="card-title mb-2">Total Deaths</h5>
              <div id="total-deaths" class="display-6 fw-bold text-primary"></div>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
          <div class="card shadow h-100 border-0 bg-gradient" style="background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);">
            <div class="card-body text-center">
              <h5 class="card-title mb-2">Unique Causes</h5>
              <div id="unique-causes" class="display-6 fw-bold text-danger"></div>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
          <div class="card shadow h-100 border-0 bg-gradient" style="background: linear-gradient(135deg, #fceabb 0%, #f8b500 100%);">
            <div class="card-body text-center">
              <h5 class="card-title mb-2">Unique Races</h5>
              <div id="unique-races" class="display-6 fw-bold text-warning"></div>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
          <div class="card shadow h-100 border-0 bg-gradient" style="background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);">
            <div class="card-body text-center">
              <h5 class="card-title mb-2">Unique Sexes</h5>
              <div id="unique-sexes" class="display-6 fw-bold text-success"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="row mb-4">
        <div class="col-md-8 mb-4">
          <div class="p-3 shadow rounded bg-white">
            <div class="mb-3">
              <label for="causeSelect" class="form-label">Cause</label>
              <select id="causeSelect" class="form-select"></select>
            </div>
            <div class="mb-3">
              <label for="raceSelect" class="form-label">Race</label>
              <select id="raceSelect" class="form-select"></select>
            </div>
            <div class="mb-3">
              <label for="sexSelect" class="form-label">Sex</label>
              <select id="sexSelect" class="form-select"></select>
            </div>
            <div id="map-title" class="mb-2"></div>
            <div id="choropleth" class="chart mb-4"></div>
          </div>
        </div>
        <div class="col-md-4 mb-4">
          <div class="p-3 shadow rounded bg-white h-100">
            <h5 class="mb-3 text-center">Deaths by Sex</h5>
            <div id="sex-pie-chart" style="height:320px;"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Map and Visualizations -->
    <section class="mb-4">
      <h2 class="h4 mb-3">Cause & Chapter Visualizations</h2>
      <div id="timeSeries" class="chart"></div>
    </section>

    <!-- Data & Usage Notes -->
    <section class="mb-4">
      <h2 class="h4">Data & Usage</h2>
      <ul>
        <li><strong>Recommended export:</strong> CDC WONDER provisional multiple cause of death by week/month, with columns for year, state, county, ICD-10 cause, race, age-group, urbanization, deaths, population.</li>
        <li><strong>Preprocessing:</strong> compute rates per 100,000 (deaths / population * 100000). For comparisons over time, consider age-adjustment using a standard population.</li>
        <li><strong>To use your own CSV:</strong> ensure column names like <code>year</code>, <code>state</code> (2-letter), <code>cause</code>, <code>race</code>, <code>urbanization</code>, <code>deaths</code>, and <code>population</code>.</li>
      </ul>
    </section>

    <!-- Footer -->
    <footer class="mt-4 mb-5 border-top pt-3">
      <small>Created by Khaleesi Chen — Exploring CDC provisional mortality data (2018–2024).</small>
    </footer>
  </div>

  <!-- Load topojson-client (used by choropleth) and site scripts -->
  <script src="https://unpkg.com/topojson-client@3/dist/topojson-client.min.js"></script>
  <script src="js/data-loader.js"></script>
  <script src="js/ucd-mcd-charts.js"></script>
  <script src="js/choropleth.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/d3@7"></script>
  <script>
    // Initialize page: load remote datasets and render modules
    (async function () {
      try {
        const data = await window.loadMortalityData();

        // Render UCD/MCD interactive chart (uses the Cause CSV)
        renderUcdMcd('#timeSeries', data.Cause);

        // Helper to get unique, sorted values for dropdowns
        function getUniqueSorted(arr, key) {
          return Array.from(new Set(arr.map(d => d[key]).filter(Boolean))).sort();
        }

        // Populate dropdowns
        function populateDropdown(id, values) {
          const sel = document.getElementById(id);
          if (!sel) return;
          sel.innerHTML = '';
          values.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v;
            opt.textContent = v;
            sel.appendChild(opt);
          });
        }

        // Populate all dropdowns from data, filtering out unwanted cause label
        const causes = getUniqueSorted(data.deathData, 'cause').filter(c => c && !c.includes('Data not shown due to 6 month lag'));
        const races = getUniqueSorted(data.deathData, 'race');
        const sexes = getUniqueSorted(data.deathData, 'sex');
        populateDropdown('causeSelect', causes);
        populateDropdown('raceSelect', races);
        populateDropdown('sexSelect', sexes);

        // Set default cause to first available if present
        if (causes.length && !document.getElementById('causeSelect').value)
          document.getElementById('causeSelect').value = causes[0];

        // Render choropleth using normalized deathData and wire controls
        function renderMapFromControls(localDeathData) {
          const cause = document.getElementById('causeSelect').value;
          const race = document.getElementById('raceSelect').value;
          const sex = document.getElementById('sexSelect').value;
          const ddata = localDeathData || data.deathData;
          const filtered = ddata.filter(d =>
            (!cause || d.cause === cause) &&
            (!race || d.race === race) &&
            (!sex || d.sex === sex)
          );
          renderChoropleth('#choropleth', filtered, data.us, { cause, race, sex });
        }

        renderMapFromControls();

        // Re-render map when selectors change
        ['causeSelect','raceSelect','sexSelect'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.addEventListener('change', () => renderMapFromControls());
        });

        // Summary cards
        document.getElementById('total-deaths').textContent = d3.format(',')(d3.sum(data.deathData, d => d.deaths));
        document.getElementById('unique-causes').textContent = d3.format(',')(new Set(data.deathData.map(d => d.cause)).size);
        document.getElementById('unique-races').textContent = d3.format(',')(new Set(data.deathData.map(d => d.race)).size);
        document.getElementById('unique-sexes').textContent = d3.format(',')(new Set(data.deathData.map(d => d.sex)).size);

        // Pie chart for deaths by sex
        const pieData = Array.from(d3.rollup(data.deathData, v => d3.sum(v, d => d.deaths), d => d.sex), ([sex, deaths]) => ({ sex, deaths }));
        const width = 320, height = 320, radius = Math.min(width, height) / 2;
        const color = d3.scaleOrdinal().domain(pieData.map(d => d.sex)).range(["#4e79a7", "#f28e2b", "#e15759"]);
        const svg = d3.select('#sex-pie-chart').append('svg').attr('width', width).attr('height', height);
        const g = svg.append('g').attr('transform', `translate(${width/2},${height/2})`);
        const pie = d3.pie().value(d => d.deaths);
        const arc = d3.arc().innerRadius(60).outerRadius(radius - 10);
        const arcs = g.selectAll('arc').data(pie(pieData)).enter().append('g');
        arcs.append('path')
            .attr('d', arc)
            .attr('fill', d => color(d.data.sex))
            .attr('stroke', '#fff')
            .attr('stroke-width', 2)
            .on('mouseover', function(event, d) {
                d3.select(this).attr('opacity', 0.7);
            })
            .on('mouseout', function(event, d) {
                d3.select(this).attr('opacity', 1);
            });
        arcs.append('text')
            .attr('transform', d => `translate(${arc.centroid(d)})`)
            .attr('text-anchor', 'middle')
            .attr('dy', '0.35em')
            .style('font-size', '1.1rem')
            .style('font-weight', '600')
            .text(d => d.data.sex);

      } catch (err) {
        console.error('Error initializing visualizations', err);
        const msg = err && err.message ? err.message : String(err);
        alert('Failed to load remote datasets: ' + msg);
      }
    })();
  </script>
</body>
</html>
