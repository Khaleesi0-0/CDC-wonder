<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Visualizing Mortality Patterns in the U.S. (2018-2025)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-2.24.2.min.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    :root {
      --bg: #050816;
      --bg-alt: #0b1020;
      --card-bg: #0f172a;
      --panel-bg: #0f172a;
      --accent: #6366f1;
      --accent-strong: #4f46e5;
      --accent-soft: rgba(99, 102, 241, 0.12);
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --border-subtle: rgba(148, 163, 184, 0.25);
      --surface-glow: rgba(99, 102, 241, 0.18);
      --radius-lg: 18px;
      --radius-xl: 24px;
      --shadow-soft: 0 20px 50px rgba(0, 0, 0, 0.45);
      --shadow-subtle: 0 12px 30px rgba(0, 0, 0, 0.4);
      --highlight: #f97316;
    }
    * { box-sizing: border-box; }
    body {
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, Roboto, "Helvetica Neue", Arial, sans-serif;
      background: radial-gradient(circle at 10% 10%, rgba(99, 102, 241, 0.15), transparent 35%), radial-gradient(circle at 80% 0%, rgba(34, 211, 238, 0.12), transparent 38%), #050816;
      color: var(--text-main);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
    }
    h1, h2, h3, h4, h5 { color: var(--text-main); font-weight: 700; }
    a { color: #a5b4fc; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .text-muted { color: var(--text-muted) !important; }
    .content-panel {
      background: linear-gradient(150deg, rgba(15, 23, 42, 0.95), rgba(11, 16, 32, 0.9));
      border-radius: var(--radius-xl);
      padding: 24px 28px;
      box-shadow: var(--shadow-subtle);
      border: 1px solid var(--border-subtle);
      backdrop-filter: blur(6px);
    }
    .content-panel + .content-panel { margin-top: 18px; }
    .hero {
      padding: 36px 40px;
      border-radius: 28px;
      background: linear-gradient(135deg, rgba(79, 70, 229, 0.3), rgba(15, 183, 255, 0.08)), linear-gradient(145deg, #0b1020, #0f172a 55%, #0b1020 100%);
      color: var(--text-main);
      box-shadow: var(--shadow-soft);
      border: 1px solid rgba(99, 102, 241, 0.35);
      position: relative;
      overflow: hidden;
    }
    .hero::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 20% 10%, rgba(99, 102, 241, 0.25), transparent 35%), radial-gradient(circle at 80% 10%, rgba(79, 70, 229, 0.25), transparent 40%);
      pointer-events: none;
    }
    .hero h1, .hero h1 small { color: var(--text-main); }
    .hero small { color: rgba(229, 231, 235, 0.8); }
    .hero .lead { color: rgba(229, 231, 235, 0.9); max-width: 960px; }
    section .section-title { font-size: 1.45rem; margin-bottom: 0.75rem; letter-spacing: -0.01em; color: var(--text-main); }
    section .section-desc { color: var(--text-muted); }
    .controls { gap: 12px; display: flex; flex-wrap: wrap; align-items: center; }
    .chart {
      min-height: 360px;
      margin-bottom: 24px;
      background: radial-gradient(circle at 0 0, rgba(99, 102, 241, 0.08), rgba(11, 16, 32, 0.92));
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.02), var(--shadow-subtle);
      padding: 8px;
    }
    .viz-card {
      background: linear-gradient(180deg, rgba(11,16,32,0.95), rgba(5,8,22,0.92));
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-subtle);
      color: var(--text-main);
    }
    .viz-card h5,
    .viz-card label { color: var(--text-main); }
    .viz-card .small { color: var(--text-muted) !important; }
    #choropleth,
    #state-trend-chart {
      background: #0c1224;
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 14px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02);
      padding: 6px;
    }
    #map-title { color: var(--text-main); font-weight: 600; }
    #map-title {
      font-weight: 700;
      letter-spacing: -0.01em;
      color: #f8fafc;
      background: linear-gradient(120deg, rgba(99,102,241,0.24), rgba(15,23,42,0.85));
      border: 1px solid var(--border-subtle);
      padding: 0.65rem 0.85rem;
      border-radius: 12px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06), 0 12px 24px rgba(0,0,0,0.28);
      font-size: 1rem;
      line-height: 1.4;
      text-shadow: 0 2px 6px rgba(0,0,0,0.45);
    }
    @media (max-width: 768px) { .controls { flex-direction: column; align-items: stretch; } }
    .note { font-size: 0.9rem; color: var(--text-muted); }
    .form-label { color: var(--text-main); font-weight: 600; }
    .form-select {
      background-color: var(--bg-alt);
      color: var(--text-main);
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.03);
    }
    .card {
      background: linear-gradient(160deg, rgba(99, 102, 241, 0.08), rgba(15, 23, 42, 0.94));
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-subtle);
      color: var(--text-main);
      box-shadow: var(--shadow-subtle);
    }
    .card .card-title { color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; font-size: 0.9rem; }
    .card .display-6 { color: #e5e7eb; }
    .badge { padding: 0.6rem 0.9rem; border-radius: 999px; font-weight: 700; }
    .badge.bg-primary-subtle { background: rgba(99, 102, 241, 0.15) !important; color: #c7d2fe !important; }
    .badge.bg-warning-subtle { background: rgba(234, 179, 8, 0.15) !important; color: #facc15 !important; }
    .badge.bg-info-subtle { background: rgba(56, 189, 248, 0.12) !important; color: #67e8f9 !important; }
    .btn {
      border-radius: 999px;
      font-weight: 600;
      padding: 0.55rem 1.2rem;
      border: 1px solid transparent;
      transition: transform 0.15s ease, box-shadow 0.15s ease, background 0.15s ease, border-color 0.15s ease;
    }
    .btn-primary {
      background: radial-gradient(circle at 0 0, #a855f7, #4f46e5);
      border-color: rgba(99, 102, 241, 0.5);
      box-shadow: 0 18px 45px rgba(79, 70, 229, 0.35);
    }
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 22px 50px rgba(79, 70, 229, 0.45);
      background: radial-gradient(circle at 0 0, #c084fc, #4f46e5);
    }
    .btn-outline-primary {
      color: var(--text-main);
      border-color: rgba(99, 102, 241, 0.5);
      background: rgba(99, 102, 241, 0.08);
    }
    .btn-outline-primary:hover {
      background: rgba(99, 102, 241, 0.18);
      color: #fff;
      box-shadow: 0 10px 24px rgba(99, 102, 241, 0.35);
    }
    .year-slider-control { font-family: "Segoe UI", Roboto, sans-serif; color: var(--text-main); }
    .year-slider-control .year-slider-title { font-weight: 600; margin-bottom: 4px; color: var(--text-main); }
    .year-slider-control .year-slider-track { width: 100%; padding: 8px 6px 0; }
    .year-slider-control input[type=range] {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 4px;
      border-radius: 999px;
      background: linear-gradient(90deg, #1e293b, #4f46e5);
      outline: none;
      position: relative;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08);
    }
    .year-slider-control input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ffd29d, #f4a261);
      border: 2px solid #0b1020;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.35);
    }
    .year-slider-control input[type=range]::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ffd29d, #f4a261);
      border: 2px solid #0b1020;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.35);
    }
    .year-slider-control input[type=range]::-moz-range-track {
      height: 4px;
      border-radius: 999px;
      background: linear-gradient(90deg, #1e293b, #4f46e5);
    }
    .year-slider-control .year-label { color: var(--text-main); font-size: 0.95rem; }
    .year-slider-control .year-label-main { font-weight: 600; display: block; }
    .year-slider-control .year-label-note { display: block; font-size: 0.75rem; color: var(--text-muted); font-weight: 500; margin-top: 2px; }
    .year-slider-control .year-slider-value { color: var(--text-main); }
    .sunburst-path-bar { color: var(--text-main); }
    .sunburst-path-bar .crumb { padding: 4px 12px; border-radius: 999px; font-size: 0.9rem; font-weight: 600; text-transform: capitalize; letter-spacing: 0.01em; background: rgba(255,255,255,0.06); border: 1px solid var(--border-subtle); }
    .sunburst-path-bar .crumb span { display: block; color: var(--text-muted); font-size: 0.8rem; }
    #urban-sunburst path.dimmed { opacity: 0.2; transition: opacity 0.2s ease-out; }
    .text-red { color: #f87171; }
    .text-em { font-weight: 600; color: #a5b4fc; }
    .trends { border-radius: 18px; overflow: hidden; box-shadow: var(--shadow-soft); margin-top: 2rem; border: 1px solid var(--border-subtle); }
    .trends .slide { padding: 2.5rem; }
    .trends-intro { background: radial-gradient(circle at 20% 20%, rgba(99, 102, 241, 0.3), transparent 35%), linear-gradient(135deg, #0b1020, #0f172a 60%, #0b1020); color: var(--text-main); position: relative; }
    .trends-intro .bg-opacity { background: rgba(5, 8, 22, 0.55); border-radius: 18px; padding: 1.5rem; border: 1px solid var(--border-subtle); box-shadow: var(--shadow-subtle); }
    .trends-intro .intro-para { max-width: 720px; }
    .trends-intro h2 { font-size: 2rem; font-weight: 700; color: #fcd34d; text-shadow: 0 6px 20px rgba(0,0,0,0.35); }
    .trends-intro h5 { font-weight: 400; line-height: 1.4; color: var(--text-main); }
    .trends-viz { background: var(--panel-bg); }
    .viz-wrapper { display: flex; flex-wrap: wrap; gap: 1.5rem; }
    #trends-wrapper { display: flex; flex-wrap: wrap; gap: 1.5rem; }
    #filter-buttons { display: flex; flex-direction: column; gap: 0.5rem; min-width: 160px; }
    #filter-buttons button {
      border: 1px solid var(--border-subtle);
      padding: 0.65rem 1rem;
      border-radius: 12px;
      background: rgba(99, 102, 241, 0.08);
      color: var(--text-main);
      font-weight: 600;
      transition: all 0.2s ease;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02);
    }
    #filter-buttons button.active {
      background: radial-gradient(circle at 0 0, #a855f7, #4f46e5);
      color: #fff;
      box-shadow: 0 14px 30px rgba(79, 70, 229, 0.35);
      border-color: rgba(99, 102, 241, 0.6);
    }
    #stack-chart-content {
      flex: 1 1 520px;
      background: rgba(15, 23, 42, 0.95);
      border-radius: 18px;
      padding: 1rem;
      box-shadow: inset 0 0 0 1px rgba(148,163,184,0.15), var(--shadow-subtle);
      position: relative;
    }
    .stack-chart-svg { width: 100%; height: 420px; }
    .stack-layer.focused { stroke: #e5e7eb; stroke-width: 1.4px; }
    .stack-hover-line { stroke: #e5e7eb; stroke-width: 1.2px; stroke-dasharray: 4 4; opacity: 0; pointer-events: none; }
    .stack-tooltip { position: absolute; background: rgba(2,6,23,0.95); color: #fff; padding: 0.6rem 0.9rem; border-radius: 10px; box-shadow: 0 10px 20px rgba(0,0,0,0.35); font-size: 0.85rem; pointer-events: none; display: none; border: 1px solid var(--border-subtle); }
    #stack-legend { margin-top: 1rem; display: flex; flex-direction: column; gap: 0.4rem; color: var(--text-main); }
    #stack-legend .legend-items { display: flex; flex-wrap: wrap; gap: 0.6rem; }
    #stack-legend .legend-item { display: flex; align-items: center; gap: 0.4rem; padding: 0.2rem 0.6rem; border-radius: 999px; background: rgba(255,255,255,0.06); border: 1px solid var(--border-subtle); font-size: 0.85rem; color: var(--text-main); }
    #stack-legend .legend-swatch { width: 10px; height: 10px; border-radius: 50%; }
    .focus-chart {
      margin-top: 1rem;
      background: rgba(11, 16, 32, 0.92);
      border-radius: 16px;
      padding: 0.75rem 1rem 1rem;
      box-shadow: inset 0 0 0 1px rgba(148,163,184,0.18);
      position: relative;
      min-height: 180px;
      color: var(--text-main);
    }
    .focus-chart-header { font-weight: 600; color: var(--text-main); margin-bottom: 0.5rem; font-size: 0.95rem; letter-spacing: 0.02em; text-transform: uppercase; }
    .focus-chart-svg { width: 100%; height: 200px; display: none; }
    .focus-chart-empty { position: absolute; left: 0; right: 0; bottom: 0; top: 36px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; color: var(--text-muted); font-weight: 500; text-align: center; padding: 0 1.5rem; }
    #trends-insights-wrapper {
      flex: 0 0 260px;
      background: linear-gradient(180deg, rgba(15, 23, 42, 0.95), rgba(11,16,32,0.92));
      color: #e2e8f0;
      border-radius: 18px;
      padding: 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.06), var(--shadow-subtle);
    }
    #trends-next { border: none; border-radius: 999px; padding: 0.6rem 1.2rem; background: #f97316; color: #0b1020; font-weight: 700; align-self: flex-start; box-shadow: 0 12px 26px rgba(249, 115, 22, 0.3); }
    .center-page { display: flex; align-items: center; justify-content: center; gap: 0.5rem; letter-spacing: 0.15em; text-transform: uppercase; font-size: 0.85rem; margin-top: 1.5rem; color: rgba(255,255,255,0.8); }
    .center-page span { display: inline-block; width: 20px; height: 1px; background: currentColor; }
    .scroll-down { text-align: center; color: #9ca3af; margin-top: 1rem; font-size: 0.85rem; letter-spacing: 0.08em; text-transform: uppercase; }
    .scroll-down span { display: inline-block; width: 1px; height: 24px; background: currentColor; margin-right: 0.6rem; vertical-align: middle; }
    @media (max-width: 992px) {
      #filter-buttons { flex-direction: row; flex-wrap: wrap; }
      #filter-buttons button { flex: 1 1 auto; text-align: center; }
      #trends-insights-wrapper { flex: 1 1 100%; }
    }
    footer {
      background: #0b1020;
      color: rgba(229,231,235,0.75);
      border-radius: 20px;
      padding: 18px 28px;
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-subtle);
    }
    footer small { color: rgba(229,231,235,0.9); }
    #definition-display {
      background: rgba(11,16,32,0.9);
      border: 1px solid var(--border-subtle);
      color: var(--text-main);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.04), var(--shadow-subtle);
    }
    #definition-display .text-muted { color: var(--text-muted) !important; }
    #definition-text { color: var(--text-main); }
    .sunburst-tooltip {
      background: rgba(5,8,22,0.95);
      color: #f8fafc;
      border: 1px solid var(--border-subtle);
      padding: 0.6rem 0.75rem;
      border-radius: 12px;
      box-shadow: 0 14px 28px rgba(0,0,0,0.35);
      font-size: 0.9rem;
      line-height: 1.4;
    }
  </style>
</head>
<body>
  <div class="container py-4">
    <!-- Header -->
    <header class="hero mb-4">
      <h1 class="mb-2">Visualizing Mortality Patterns in the U.S.<br><small class="text-white">Trends by Cause, Demographics, and Urbanization (2018-2025)</small></h1>
      <p class="mb-1"><strong>Author:</strong> Khaleesi Chen</p>
      <p class="lead">Understanding how mortality patterns differ across regions, races, and causes of death offers essential insights into public health disparities and emerging threats. This site presents interactive, multi-level visualizations built from CDC WONDER provisional mortality data.</p>
    </header>

    <!-- Orientation -->
    <section class="mb-4 content-panel">
      <h2 class="h4">How to read this page</h2>
      <p class="mb-2">The story flows from a quick national snapshot, to which causes dominate, to where and how people die.</p>
      <ul class="mb-0">
        <li><strong>Prelude:</strong> Use the chapter treemap to see which underlying-cause chapters account for the most deaths in the latest year, then click a block to view that chapter’s crude-rate trend over time.</li>
        <li><strong>Chapter 1:</strong> Start with totals and the state map; filter by cause, race, and sex to see which groups and places carry higher crude death rates.</li>
        <li><strong>Chapter 2:</strong> Explore leading underlying causes and their sub-chapters; click a chapter bar to reveal its top sub-chapters.</li>
        <li><strong>Chapters 3 &amp; 4:</strong> Dive into urbanization tiers, ten-year age bands, and place of death to understand where deaths occur and how the burden shifts across people and places.</li>
      </ul>
    </section>

    <!-- Prelude: Disease chapter treemap + trend -->
    <section class="mb-4 content-panel">
      <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap">
        <div>
          <h2 class="h4 mb-1">Prelude: Which chapters dominate right now?</h2>
          <p class="mb-0 text-muted">Latest-year deaths by underlying-cause ICD-10 chapter. Each rectangle’s area is proportional to deaths; click a chapter to see its crude rate trend across years. Data: <code>desease-trend.csv</code>.</p>
        </div>
        <span class="badge bg-info-subtle text-info fw-semibold">New</span>
      </div>
      <div class="row g-3">
        <div class="col-lg-8">
          <div id="disease-treemap" class="chart"></div>
          <p class="note mt-2 mb-0">Each block is an ICD-10 underlying-cause chapter; larger blocks correspond to more deaths in the latest year. Hover for details and click to update the trend panel.</p>
        </div>
        <div class="col-lg-4">
          <div class="chart" style="min-height: 340px;">
            <div id="disease-trend"></div>
          </div>
          <p class="note mt-2 mb-0">The line shows how the selected chapter’s crude death rate has changed over time.</p>
        </div>
      </div>
    </section>

    <!-- Data & framing -->
    <section class="mb-4 content-panel">
      <h2 class="h4">Data & framing</h2>
      <p class="note mb-2">CDC WONDER provisional multiple cause of death, 2018-2025 (latest available). Age and place-of-death views come from the <code>ageLocation.csv</code> pull dated Nov 21, 2025.</p>
      <p class="mb-0">Goal: surface how mortality patterns shift by cause, race, sex, age, geography, urbanization, and where deaths occur.</p>
    </section>

    <!-- Chapter 1 -->
    <section class="mb-4 content-panel">
      <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap">
        <div>
          <h2 class="h4 mb-1">Chapter 1: National pulse</h2>
          <p class="mb-0 text-muted">Scan the totals, then use the state map to compare crude death rates by cause, race, and sex. Click a state or use the dropdown to see how its deaths and crude rate have changed over time.</p>
        </div>
        <span class="badge bg-primary-subtle text-primary fw-semibold">Baseline</span>
      </div>
      <div class="row g-4 mb-4 align-items-stretch">
        <div class="col-lg-3 col-md-6 mb-3">
          <div class="card shadow h-100 border-0 bg-gradient" style="background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);">
            <div class="card-body text-center">
              <h5 class="card-title mb-2">Total Deaths</h5>
              <div id="total-deaths" class="display-6 fw-bold text-primary"></div>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
          <div class="card shadow h-100 border-0 bg-gradient" style="background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);">
            <div class="card-body text-center">
              <h5 class="card-title mb-2">Unique Causes</h5>
              <div id="unique-causes" class="display-6 fw-bold text-danger"></div>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
          <div class="card shadow h-100 border-0 bg-gradient" style="background: linear-gradient(135deg, #fceabb 0%, #f8b500 100%);">
            <div class="card-body text-center">
              <h5 class="card-title mb-2">Unique Races</h5>
              <div id="unique-races" class="display-6 fw-bold text-warning"></div>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
          <div class="card shadow h-100 border-0 bg-gradient" style="background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);">
            <div class="card-body text-center">
              <h5 class="card-title mb-2">Unique Sexes</h5>
              <div id="unique-sexes" class="display-6 fw-bold text-success"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="row mb-1">
        <div class="col-md-8 mb-4">
          <div class="p-3 shadow rounded viz-card h-100">
            <div class="row g-3">
              <div class="col-sm-4">
                <label for="causeSelect" class="form-label">Cause</label>
                <select id="causeSelect" class="form-select"></select>
              </div>
              <div class="col-sm-4">
                <label for="raceSelect" class="form-label">Race</label>
                <select id="raceSelect" class="form-select"></select>
              </div>
              <div class="col-sm-4">
                <label for="sexSelect" class="form-label">Sex</label>
                <select id="sexSelect" class="form-select"></select>
              </div>
            </div>
            <div id="map-title" class="mt-3 mb-2"></div>
            <div id="choropleth" class="chart mb-2"></div>
            <p class="note mb-0">Darker shades indicate higher crude death rates for the selected cause, race, and sex. Click a state to sync the trend chart on the right.</p>
          </div>
        </div>
        <div class="col-md-4 mb-4">
          <div class="p-3 shadow rounded viz-card h-100">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h5 class="mb-0">State trend</h5>
              <select id="stateSelect" class="form-select form-select-sm w-auto"></select>
            </div>
            <p class="text-muted small mb-2">Annual deaths and crude death rates (per 100,000) for the selected state.</p>
            <div id="state-trend-chart" style="height:320px;"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Chapter 2 -->
    <section class="mb-4 content-panel">
      <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
        <div>
          <h2 class="h4 mb-1">Chapter 2: Leading underlying causes</h2>
          <p class="mb-0 text-muted">Bars rank ICD-10 underlying-cause chapters by total deaths. Click a chapter to display its top sub-chapters and see which specific causes drive the burden within that category.</p>
        </div>
        <span class="badge bg-warning-subtle text-warning fw-semibold">Trend</span>
      </div>
      <div id="timeSeries" class="chart"></div>
    </section>

    <!-- Chapter 3 -->
    <section class="mb-4 content-panel">
      <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
        <div>
          <h2 class="h4 mb-1">Chapter 3: Urban footprint</h2>
          <p class="mb-0 text-muted">Break down deaths by year and up to two categorical fields (for example, urbanization tier, race, sex, or cause chapter). Use the controls above the chart to change the year and categories and see how deaths concentrate across the urban–rural spectrum.</p>
        </div>
        <span class="badge bg-info-subtle text-info fw-semibold">Structure</span>
      </div>
      <div id="urban-deaths" class="chart mt-2"></div>
    </section>

    <!-- Urban Trends Section -->
    <section class="mb-5">
      <div class="section trends" data-anchor="trends">
        <div class="slide trends-intro bg-image">
          <div class="bg-opacity">
            <div class="intro-para">
              <h2 class="text-red">Chapter 4: Age and where deaths occur</h2>
              <h5>
                Track how deaths from the Urban and age–place datasets shift between 2018 and 2025. Swap the grouping to compare sex, race, urbanization level, cause chapters, ten-year age bands, or place of death (for example, inpatient, home, hospice, or nursing facilities).
              </h5>
            </div>
          </div>
          <div class="center-page"><span></span>Scroll</div>
        </div>

        <div class="slide trends-viz">
          <div id="trends-container" class="section-container">

            <div class="section-intro">
              <h1>Urban mortality pathways</h1>
              <h5>
                This stacked area chart shows how deaths accumulate over time and how they split across the selected grouping (urbanization tier, demographic, age band, cause chapter, or place of death).
                <br><span class="text-em">Use the buttons on the left to change the grouping, and click a colored layer to isolate that group’s trend in the focus panel.</span></br>
              </h5>
            </div>
            <div id="trends-wrapper" class="viz-wrapper">

              <!-- Buttons -->
              <div id="filter-buttons" class="viz-filter-buttons">
                <button type="button" id="gender-button">Gender</button>
                <button type="button" id="urban-button">Urbanization</button>
                <button type="button" id="ethnicity-button">Ethnicity</button>
                <button type="button" id="cause-button">Cause</button>
                <button type="button" id="age-button">Age</button>
                <button type="button" id="place-death-button">Place of Death</button>
                <button type="button" id="total-button">Total</button>
              </div>

              <!--Main Viz Wrap-->
              <div id="stack-chart-content" class="viz-content">
                  <svg class="stack-chart-svg"></svg>
                  <div id="stack-legend">
                      <div class="title">Legend</div>
                      <div class="legend-items"></div>
                  </div>
                  <div class="focus-chart">
                      <div class="focus-chart-header">Group Focus</div>
                      <svg class="focus-chart-svg"></svg>
                      <div class="focus-chart-empty">Click a layer to view its individual trend line.</div>
                  </div>
              </div>

              <!--Text-->
              <div id="trends-insights-wrapper" class="insights-wrapper">
                <h2 id="trends-insights-header" class="insights-header">Key Insights</h2>
                <div id="trends-text" class="insights-text"></div>
                <button type="button" id="trends-next" class="insights-next">Next</button>
              </div>

            </div>

          </div>
          <div class="scroll-down"><span></span>Scroll</div>
        </div>

      </div>
    </section>

    <!-- Data & Usage Notes -->
    <section class="mb-4 content-panel">
      <h2 class="h4">Methods & reuse notes</h2>
      <ul class="mb-1">
        <li><strong>Recommended export:</strong> CDC WONDER provisional multiple cause of death by week or month with year, state, ICD-10 cause, race, age-group, urbanization, deaths, population.</li>
        <li><strong>Preprocessing:</strong> compute crude rates per 100,000 (deaths / population * 100000). For comparisons over time, consider age-adjustment using a standard population.</li>
        <li><strong>Age & place-of-death view:</strong> uses ten-year age bands and place-of-death categories from <code>ageLocation.csv</code>.</li>
      </ul>
    </section>

    <!-- Interactive Definitions -->
    <section class="mb-4 content-panel">
      <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
        <div>
          <h2 class="h4 mb-1">Definitions & Notes</h2>
          <p class="mb-0 text-muted">Click a term to see how we define urbanization tiers or notable ICD-10 changes.</p>
        </div>
      </div>
      <div class="row g-3">
        <div class="col-md-6">
          <h6 class="fw-semibold">Urbanization</h6>
          <div id="urban-def-buttons" class="d-flex flex-wrap gap-2"></div>
        </div>
        <div class="col-md-6">
          <h6 class="fw-semibold">Cause updates</h6>
          <div id="cause-def-buttons" class="d-flex flex-wrap gap-2"></div>
        </div>
      </div>
      <div class="mt-3 p-3 rounded border" id="definition-display">
        <div class="text-muted small mb-1">Definition</div>
        <div id="definition-text" class="fw-semibold">Select a term to view details.</div>
      </div>
    </section>

    <!-- Footer -->
    <footer class="mt-4 mb-5 border-top pt-3">
      <small>Created by Khaleesi Chen - Exploring CDC provisional mortality data (2018-2025).</small>
    </footer>
  </div>

  <!-- Load topojson-client (used by choropleth) and site scripts -->
  <script src="https://unpkg.com/topojson-client@3/dist/topojson-client.min.js"></script>
  <script src="js/data-loader.js"></script>
  <script src="js/disease-treemap.js"></script>
  <script src="js/ucd-mcd-charts.js"></script>
  <script src="js/choropleth.js"></script>
  <script src="js/deaths-sunburst.js"></script>
  <script src="js/urban-trends.js"></script>
  <script>
    // Initialize page: load remote datasets and render modules
    (async function () {
      try {
        const data = await window.loadMortalityData();

        // Prelude treemap + trend
        if (window.renderDiseaseTreemap && data.diseaseTrends) {
          renderDiseaseTreemap('#disease-treemap', '#disease-trend', data.diseaseTrends);
        }

        // Render UCD/Sub-Chapter interactive chart (uses the Cause CSV)
        renderUcdMcd('#timeSeries', data.Cause);

        const ALL_CAUSES = 'All causes';
        const ALL_RACES = 'All races';
        const ALL_SEXES = 'All sexes';

        // Helper to get unique, sorted values for dropdowns
        function getUniqueSorted(arr, key) {
          return Array.from(new Set(arr.map(d => d[key]).filter(Boolean))).sort();
        }

        // Populate dropdowns
        function populateDropdown(id, values) {
          const sel = document.getElementById(id);
          if (!sel) return;
          sel.innerHTML = '';
          values.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v;
            opt.textContent = v;
            sel.appendChild(opt);
          });
        }

        // Populate all dropdowns from data, filtering out unwanted cause label
        const causes = [ALL_CAUSES].concat(getUniqueSorted(data.deathData, 'cause').filter(c => c && !c.includes('Data not shown due to 6 month lag')));
        const races = [ALL_RACES].concat(getUniqueSorted(data.deathData, 'race'));
        const sexes = [ALL_SEXES].concat(getUniqueSorted(data.deathData, 'sex'));
        const states = getUniqueSorted(data.stateTrends || [], 'state');
        populateDropdown('causeSelect', causes);
        populateDropdown('raceSelect', races);
        populateDropdown('sexSelect', sexes);
        populateDropdown('stateSelect', states);

        // Set default cause to first available if present
        if (causes.length && !document.getElementById('causeSelect').value)
          document.getElementById('causeSelect').value = causes[0];

        // Render choropleth using normalized deathData and wire controls
        function computeCrudeRate(deaths, population) {
          if (!population) return NaN;
          return (deaths / population) * 100000;
        }

        function aggregateByState(rows, meta = {}) {
          const grouped = d3.group(rows, d => d.stateFips);
          return Array.from(grouped, ([stateFips, stateRows]) => {
            const deaths = d3.sum(stateRows, d => d.deaths || 0);
            const population = d3.sum(stateRows, d => d.population || 0);
            return {
              state: stateRows[0]?.state,
              stateFips,
              cause: meta.cause || null,
              race: meta.race || null,
              sex: meta.sex || null,
              deaths,
              population,
              rate: computeCrudeRate(deaths, population)
            };
          }).filter(d => d.stateFips);
        }

        function renderMapFromControls(localDeathData) {
          const cause = document.getElementById('causeSelect').value;
          const race = document.getElementById('raceSelect').value;
          const sex = document.getElementById('sexSelect').value;

          // Determine dataset based on selections
          let dataset = [];
          if (cause === ALL_CAUSES) {
            dataset = data.stateTotals;
          } else if (race === ALL_RACES && sex === ALL_SEXES) {
            dataset = (data.causeTotalsByState || []).filter(d => d.cause === cause);
            if (!dataset.length) {
              const base = (localDeathData || data.deathData).filter(d => d.cause === cause);
              dataset = aggregateByState(base, { cause });
            }
          } else {
            const base = (localDeathData || data.deathData).filter(d =>
              d.cause === cause &&
              (race === ALL_RACES || d.race === race) &&
              (sex === ALL_SEXES || d.sex === sex)
            );
            dataset = aggregateByState(base, {
              cause,
              race: race === ALL_RACES ? null : race,
              sex: sex === ALL_SEXES ? null : sex
            });
          }

          const causeFilter = cause === ALL_CAUSES ? null : cause;
          const raceFilter = race === ALL_RACES ? null : race;
          const sexFilter = sex === ALL_SEXES ? null : sex;

          renderChoropleth('#choropleth', dataset, data.us, {
            cause: causeFilter,
            causeLabel: cause,
            race: raceFilter,
            sex: sexFilter,
            onStateClick: (stateName) => {
              const stateSelectEl = document.getElementById('stateSelect');
              if (stateSelectEl) {
                stateSelectEl.value = stateName;
                stateSelectEl.dispatchEvent(new Event('change'));
              }
              renderStateTrend(stateName);
            }
          });
        }

        renderMapFromControls();

        // Re-render map when selectors change
        ['causeSelect','raceSelect','sexSelect'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.addEventListener('change', () => renderMapFromControls());
        });

        // Summary cards
        document.getElementById('total-deaths').textContent = d3.format(',')(d3.sum(data.deathData, d => d.deaths));
        document.getElementById('unique-causes').textContent = d3.format(',')(causes.length - 1); // exclude "All causes"
        document.getElementById('unique-races').textContent = d3.format(',')(races.length - 1); // exclude "All races"
        document.getElementById('unique-sexes').textContent = d3.format(',')(sexes.length - 1); // exclude "All sexes"

        function renderStateTrend(stateName) {
          const container = d3.select('#state-trend-chart');
          container.selectAll('*').remove();
          const rows = (data.stateTrends || []).filter(d => d.state === stateName).sort((a, b) => a.year - b.year);
          if (!rows.length) {
            container.append('div').attr('class','text-center text-muted').text('No data for this state.');
            return;
          }
          const width = 320, height = 300, margin = { top: 32, right: 18, bottom: 32, left: 56 };
          const totalDeaths = d3.sum(rows, d => d.deaths || 0);
          container.append('div')
            .attr('class', 'small text-muted mb-1')
            .text(`${stateName} total deaths (all years): ${d3.format(',')(totalDeaths)}`);

          let trendTooltip = d3.select('body').select('.state-trend-tooltip');
          if (trendTooltip.empty()) {
            trendTooltip = d3.select('body').append('div')
              .attr('class', 'state-trend-tooltip')
              .style('position', 'absolute')
              .style('z-index', 2000)
              .style('background', 'rgba(15,23,42,0.92)')
              .style('color', '#e5e7eb')
              .style('padding', '8px 10px')
              .style('border-radius', '8px')
              .style('border', '1px solid rgba(148,163,184,0.35)')
              .style('font-size', '12px')
              .style('pointer-events', 'none')
              .style('display', 'none');
          }

          const svg = container.append('svg')
            .attr('width', width)
            .attr('height', height)
            .attr('viewBox', `0 0 ${width} ${height}`);
          const x = d3.scaleLinear().domain(d3.extent(rows, d => d.year)).range([margin.left, width - margin.right]);
          const y = d3.scaleLinear().domain([0, d3.max(rows, d => d.rate) || 1]).nice().range([height - margin.bottom, margin.top]);
          const line = d3.line()
            .curve(d3.curveMonotoneX)
            .x(d => x(d.year))
            .y(d => y(d.rate));
          svg.append('path')
            .datum(rows)
            .attr('fill', 'none')
            .attr('stroke', '#2563eb')
            .attr('stroke-width', 2)
            .attr('d', line);
          svg.selectAll('circle')
            .data(rows)
            .join('circle')
            .attr('cx', d => x(d.year))
            .attr('cy', d => y(d.rate))
            .attr('r', 4)
            .attr('fill', '#38bdf8')
            .attr('stroke', '#0f172a')
            .attr('stroke-width', 1)
            .on('mouseover', function(event, d) {
              trendTooltip.style('display', 'block')
                .html(`<strong>${stateName}</strong><br/>Year: ${d.year}<br/>Crude rate: ${d3.format('.1f')(d.rate || 0)}<br/>Deaths: ${d3.format(',')(d.deaths || 0)}`);
            })
            .on('mousemove', function(event) {
              trendTooltip
                .style('left', (event.pageX + 12) + 'px')
                .style('top', (event.pageY - 18) + 'px');
            })
            .on('mouseout', function() {
              trendTooltip.style('display', 'none');
            });
          svg.append('g')
            .attr('transform', `translate(0,${height - margin.bottom})`)
            .call(d3.axisBottom(x).ticks(5).tickFormat(d3.format('d')));
          svg.append('g')
            .attr('transform', `translate(${margin.left},0)`)
            .call(d3.axisLeft(y).ticks(4).tickFormat(d3.format('.1f')));
          svg.append('text')
            .attr('x', width / 2)
            .attr('y', margin.top - 12)
            .attr('text-anchor', 'middle')
            .attr('font-size', 12)
            .attr('fill', '#0f172a')
            .text(`Crude rate per 100k`);
        }

        const stateSelect = document.getElementById('stateSelect');
        if (states.length && stateSelect) {
          stateSelect.value = states[0];
          renderStateTrend(states[0]);
          stateSelect.addEventListener('change', (e) => renderStateTrend(e.target.value));
        }

        // Initialize Urban deaths sunburst (loads ../Data/Urban.csv)
        let urbanRows = null;
        try {
          urbanRows = await window.renderUrbanDeaths('#urban-deaths');
        } catch (err) {
          console.warn('Urban deaths viz not initialized:', err && err.message ? err.message : err);
        }

        if (window.renderUrbanTrends) {
          try {
            await window.renderUrbanTrends('#trends-container', urbanRows || []);
          } catch (err) {
            console.warn('Urban trends viz not initialized:', err && err.message ? err.message : err);
          }
        }

        // Interactive definitions for urbanization and cause updates
        const urbanDefs = {
          'Large central metro': 'Counties in metro areas >=1M that contain the largest principal city, are fully the principal city, or have >=250k residents of any principal city.',
          'Large fringe metro': 'Counties in metro areas >=1M that do not qualify as large central metro.',
          'Medium metro': 'Counties in metro areas of 250k to 999,999 population.',
          'Small metro': 'Counties in metro areas of 50k to 249,999 population.',
          'Micropolitan': 'Nonmetropolitan counties in micropolitan statistical areas.',
          'Noncore': 'Nonmetropolitan counties that are not micropolitan.'
        };
        const causeDefs = {
          'New causes 2023': 'Post COVID-19 condition (U09, U09.9) added as contributing causes only.',
          'New causes 2020': 'COVID-19 (U07.1) introduced.',
          'New causes 2019': 'Vaping related disorder (U07.0) introduced.',
          'New causes 2011': 'Multiple ICD-10 additions including thrombophilia (D68.5, D68.6) and staging for decubitus ulcers (L89.0-L89.9).',
          'New causes 2009': 'Gastroenteritis refinements (A09.0, A09.9), indeterminate colitis (K52.3), and immobility/insufficient intake codes.',
          'New causes 2007': 'Avian influenza (J09) and SARS (U04.9) additions.',
          'New causes 2006': 'Additions include hantavirus pulmonary syndrome (B33.4) and detailed acute pancreatitis codes (K85.x).',
          'New causes 2003': 'Other secondary pulmonary hypertension (I27.2).',
          'Discontinued 2009/2007/2006': 'Certain acute intoxication and diarrhea codes retired; terrorism categories *U01-*U03 classify into assault and suicide; see technical notes.'
        };

        function buildButtons(containerId, defs) {
          const container = document.getElementById(containerId);
          if (!container) return;
          container.innerHTML = '';
          Object.keys(defs).forEach(key => {
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-sm btn-outline-primary';
            btn.textContent = key;
            btn.addEventListener('click', () => {
              const display = document.getElementById('definition-text');
              if (display) display.textContent = defs[key] || 'No definition available.';
            });
            container.appendChild(btn);
          });
        }

        buildButtons('urban-def-buttons', urbanDefs);
        buildButtons('cause-def-buttons', causeDefs);

      } catch (err) {
        console.error('Error initializing visualizations', err);
        const msg = err && err.message ? err.message : String(err);
        alert('Failed to load remote datasets: ' + msg);
      }
    })();
  </script>
</body>
</html>
