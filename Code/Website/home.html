<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Visualizing Mortality Patterns in the U.S. (2018-2025)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-2.24.2.min.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    :root {
      --ink: #0f172a;
      --ink-soft: #1e293b;
      --sky: #e0eafc;
      --lavender: #c7d2fe;
      --peach: #ffedd5;
      --highlight: #f97316;
      --panel-bg: #ffffff;
      --muted-text: #475467;
      --border-soft: rgba(15, 23, 42, 0.08);
    }
    * { box-sizing: border-box; }
    body {
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, Roboto, "Helvetica Neue", Arial, sans-serif;
      background: radial-gradient(circle at 15% 20%, rgba(169,196,255,0.35), transparent 45%), radial-gradient(circle at 80% 10%, rgba(248,113,113,0.15), transparent 35%), #f6f8fb;
      color: var(--ink);
      line-height: 1.6;
    }
    h1, h2, h3, h4, h5 { color: var(--ink); font-weight: 700; }
    a { color: #2563eb; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .content-panel {
      background: var(--panel-bg);
      border-radius: 20px;
      padding: 24px 28px;
      box-shadow: 0 20px 50px rgba(15,23,42,0.08);
      border: 1px solid var(--border-soft);
    }
    .content-panel + .content-panel { margin-top: 18px; }
    .hero {
      padding: 36px 40px;
      border-radius: 28px;
      background: linear-gradient(125deg, #0b1b3b 0%, #123a78 55%, #0d2555 100%);
      color: #f2f5ff;
      box-shadow: 0 30px 60px rgba(15,23,42,0.25);
      border: 1px solid rgba(255,255,255,0.08);
    }
    .hero h1, .hero h1 small { color: #f2f5ff; }
    .hero small { color: rgba(242,245,255,0.85); }
    .hero .lead { color: rgba(242,245,255,0.92); }
    section .section-title { font-size: 1.4rem; margin-bottom: 0.75rem; letter-spacing: 0.01em; }
    section .section-desc { color: var(--muted-text); }
    .controls { gap: 12px; display: flex; flex-wrap: wrap; align-items: center; }
    .chart { min-height: 360px; margin-bottom: 24px; }
    @media (max-width: 768px) { .controls { flex-direction: column; align-items: stretch; } }
    .note { font-size: 0.9rem; color: #444; }
    .year-slider-control { font-family: "Segoe UI", Roboto, sans-serif; }
    .year-slider-control .year-slider-title { font-weight: 600; margin-bottom: 4px; color: #0f172a; }
    .year-slider-control .year-slider-track { width: 100%; padding: 8px 6px 0; }
    .year-slider-control input[type=range] {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 4px;
      border-radius: 999px;
      background: linear-gradient(90deg, #111827, #1e2761);
      outline: none;
      position: relative;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.15);
    }
    .year-slider-control input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ffd29d, #f4a261);
      border: 2px solid #0f172a;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    }
    .year-slider-control input[type=range]::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ffd29d, #f4a261);
      border: 2px solid #0f172a;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
    }
    .year-slider-control input[type=range]::-moz-range-track {
      height: 4px;
      border-radius: 999px;
      background: linear-gradient(90deg, #111827, #1e2761);
    }
    .year-slider-control .year-label { color: #101828; font-size: 0.95rem; }
    .year-slider-control .year-label-main { font-weight: 600; display: block; }
    .year-slider-control .year-label-note { display: block; font-size: 0.75rem; color: #475467; font-weight: 500; margin-top: 2px; }
    .year-slider-control .year-slider-value { color: #0f172a; }
    .sunburst-path-bar { color: #f8fafc; }
    .sunburst-path-bar .crumb { padding: 4px 12px; border-radius: 999px; font-size: 0.9rem; font-weight: 600; text-transform: capitalize; letter-spacing: 0.01em; }
    .sunburst-path-bar .crumb span { display: block; }
    #urban-sunburst path.dimmed { opacity: 0.2; transition: opacity 0.2s ease-out; }
    .text-red { color: #ef4444; }
    .text-em { font-weight: 600; color: #1d4ed8; }
    .trends { border-radius: 18px; overflow: hidden; box-shadow: 0 24px 40px rgba(15, 23, 42, 0.12); margin-top: 2rem; }
    .trends .slide { padding: 2.5rem; }
    .trends-intro { background: linear-gradient(135deg, #0b162f, #1b3c7a 55%, #10213f); color: #e8eefc; position: relative; }
    .trends-intro .bg-opacity { background: rgba(11, 22, 47, 0.65); border-radius: 18px; padding: 1.5rem; }
    .trends-intro .intro-para { max-width: 720px; }
    .trends-intro h2 { font-size: 2rem; font-weight: 700; color: #ffd166; text-shadow: 0 6px 20px rgba(0,0,0,0.4); }
    .trends-intro h5 { font-weight: 400; line-height: 1.4; color: #f1f5ff; }
    .trends-viz { background: #fff; }
    .viz-wrapper { display: flex; flex-wrap: wrap; gap: 1.5rem; }
    #trends-wrapper { display: flex; flex-wrap: wrap; gap: 1.5rem; }
    #filter-buttons { display: flex; flex-direction: column; gap: 0.5rem; min-width: 160px; }
    #filter-buttons button { border: none; padding: 0.65rem 1rem; border-radius: 999px; background: #eef2ff; color: #1d4ed8; font-weight: 600; transition: all 0.2s ease; }
    #filter-buttons button.active { background: #1d4ed8; color: #fff; box-shadow: 0 10px 20px rgba(29, 78, 216, 0.2); }
    #stack-chart-content { flex: 1 1 520px; background: #f8fafc; border-radius: 18px; padding: 1rem; box-shadow: inset 0 0 0 1px rgba(148,163,184,0.25); position: relative; }
    .stack-chart-svg { width: 100%; height: 420px; }
    .stack-layer.focused { stroke: #0f172a; stroke-width: 1.4px; }
    .stack-hover-line { stroke: #0f172a; stroke-width: 1.2px; stroke-dasharray: 4 4; opacity: 0; pointer-events: none; }
    .stack-tooltip { position: absolute; background: rgba(15,23,42,0.95); color: #fff; padding: 0.6rem 0.9rem; border-radius: 10px; box-shadow: 0 10px 20px rgba(15,23,42,0.35); font-size: 0.85rem; pointer-events: none; display: none; }
    #stack-legend { margin-top: 1rem; display: flex; flex-direction: column; gap: 0.4rem; }
    #stack-legend .legend-items { display: flex; flex-wrap: wrap; gap: 0.6rem; }
    #stack-legend .legend-item { display: flex; align-items: center; gap: 0.4rem; padding: 0.2rem 0.6rem; border-radius: 999px; background: #fff; border: 1px solid rgba(148,163,184,0.4); font-size: 0.85rem; }
    #stack-legend .legend-swatch { width: 10px; height: 10px; border-radius: 50%; }
    .focus-chart { margin-top: 1rem; background: #fff; border-radius: 16px; padding: 0.75rem 1rem 1rem; box-shadow: inset 0 0 0 1px rgba(148,163,184,0.25); position: relative; min-height: 180px; }
    .focus-chart-header { font-weight: 600; color: #0f172a; margin-bottom: 0.5rem; font-size: 0.95rem; letter-spacing: 0.02em; text-transform: uppercase; }
    .focus-chart-svg { width: 100%; height: 200px; display: none; }
    .focus-chart-empty { position: absolute; left: 0; right: 0; bottom: 0; top: 36px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; color: #475467; font-weight: 500; text-align: center; padding: 0 1.5rem; }
    #trends-insights-wrapper { flex: 0 0 260px; background: #0f172a; color: #e2e8f0; border-radius: 18px; padding: 1.25rem; display: flex; flex-direction: column; gap: 1rem; box-shadow: inset 0 0 0 1px rgba(255,255,255,0.08); }
    #trends-next { border: none; border-radius: 999px; padding: 0.6rem 1.2rem; background: #f97316; color: #fff; font-weight: 600; align-self: flex-start; }
    .center-page { display: flex; align-items: center; justify-content: center; gap: 0.5rem; letter-spacing: 0.15em; text-transform: uppercase; font-size: 0.85rem; margin-top: 1.5rem; color: rgba(255,255,255,0.8); }
    .center-page span { display: inline-block; width: 20px; height: 1px; background: currentColor; }
    .scroll-down { text-align: center; color: #adb5bd; margin-top: 1rem; font-size: 0.85rem; letter-spacing: 0.08em; text-transform: uppercase; }
    .scroll-down span { display: inline-block; width: 1px; height: 24px; background: currentColor; margin-right: 0.6rem; vertical-align: middle; }
    @media (max-width: 992px) {
      #filter-buttons { flex-direction: row; flex-wrap: wrap; }
      #filter-buttons button { flex: 1 1 auto; text-align: center; }
      #trends-insights-wrapper { flex: 1 1 100%; }
    }
    footer { background: var(--ink); color: rgba(248,250,252,0.7); border-radius: 20px; padding: 18px 28px; }
    footer small { color: rgba(248,250,252,0.9); }
  </style>
</head>
<body>
  <div class="container py-4">
    <!-- Header -->
    <header class="hero mb-4">
      <h1 class="mb-2">Visualizing Mortality Patterns in the U.S.<br><small class="text-white">Trends by Cause, Demographics, and Urbanization (2018-2025)</small></h1>
      <p class="mb-1"><strong>Author:</strong> Khaleesi Chen</p>
      <p class="lead">Understanding how mortality patterns differ across regions, races, and causes of death offers essential insights into public health disparities and emerging threats. This site presents interactive, multi-level visualizations built from CDC WONDER provisional mortality data.</p>
    </header>

    <!-- Orientation -->
    <section class="mb-4 content-panel">
      <h2 class="h4">How to read this page</h2>
      <p class="mb-2">The story flows from national pulse, to causes, to where and how people die.</p>
      <ul class="mb-0">
        <li><strong>Chapter 1:</strong> Start with totals and a state-by-state view to see who is most affected.</li>
        <li><strong>Chapter 2:</strong> Explore secondary causes over time (ICD-10 chapters aligned to the 113 underlying list).</li>
        <li><strong>Chapters 3 & 4:</strong> Dive into urbanization, age bands, and place of death to understand context.</li>
      </ul>
    </section>

    <!-- Data & framing -->
    <section class="mb-4 content-panel">
      <h2 class="h4">Data & framing</h2>
      <p class="note mb-2">CDC WONDER provisional multiple cause of death, 2018-2025 (latest available). Age and place-of-death views come from the <code>ageLocation.csv</code> pull dated Nov 21, 2025.</p>
      <p class="mb-0">Goal: surface how mortality patterns shift by cause, race, sex, age, geography, urbanization, and where deaths occur.</p>
    </section>

    <!-- Chapter 1 -->
    <section class="mb-4 content-panel">
      <div class="d-flex justify-content-between align-items-center mb-2 flex-wrap">
        <div>
          <h2 class="h4 mb-1">Chapter 1: National pulse</h2>
          <p class="mb-0 text-muted">Scan the totals, then filter the map by cause, race, and sex to see who and where the burden falls on.</p>
        </div>
        <span class="badge bg-primary-subtle text-primary fw-semibold">Baseline</span>
      </div>
      <div class="row g-4 mb-4 align-items-stretch">
        <div class="col-lg-3 col-md-6 mb-3">
          <div class="card shadow h-100 border-0 bg-gradient" style="background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);">
            <div class="card-body text-center">
              <h5 class="card-title mb-2">Total Deaths</h5>
              <div id="total-deaths" class="display-6 fw-bold text-primary"></div>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
          <div class="card shadow h-100 border-0 bg-gradient" style="background: linear-gradient(135deg, #fbc2eb 0%, #a6c1ee 100%);">
            <div class="card-body text-center">
              <h5 class="card-title mb-2">Unique Causes</h5>
              <div id="unique-causes" class="display-6 fw-bold text-danger"></div>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
          <div class="card shadow h-100 border-0 bg-gradient" style="background: linear-gradient(135deg, #fceabb 0%, #f8b500 100%);">
            <div class="card-body text-center">
              <h5 class="card-title mb-2">Unique Races</h5>
              <div id="unique-races" class="display-6 fw-bold text-warning"></div>
            </div>
          </div>
        </div>
        <div class="col-lg-3 col-md-6 mb-3">
          <div class="card shadow h-100 border-0 bg-gradient" style="background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);">
            <div class="card-body text-center">
              <h5 class="card-title mb-2">Unique Sexes</h5>
              <div id="unique-sexes" class="display-6 fw-bold text-success"></div>
            </div>
          </div>
        </div>
      </div>
      <div class="row mb-1">
        <div class="col-md-8 mb-4">
          <div class="p-3 shadow rounded bg-white h-100">
            <div class="row g-3">
              <div class="col-sm-4">
                <label for="causeSelect" class="form-label">Cause</label>
                <select id="causeSelect" class="form-select"></select>
              </div>
              <div class="col-sm-4">
                <label for="raceSelect" class="form-label">Race</label>
                <select id="raceSelect" class="form-select"></select>
              </div>
              <div class="col-sm-4">
                <label for="sexSelect" class="form-label">Sex</label>
                <select id="sexSelect" class="form-select"></select>
              </div>
            </div>
            <div id="map-title" class="mt-3 mb-2"></div>
            <div id="choropleth" class="chart mb-3"></div>
          </div>
        </div>
        <div class="col-md-4 mb-4">
          <div class="p-3 shadow rounded bg-white h-100">
            <h5 class="mb-2 text-center">Deaths by Sex</h5>
            <p class="text-muted small text-center mb-2">Use this as a quick check before diving into causes.</p>
            <div id="sex-pie-chart" style="height:320px;"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Chapter 2 -->
    <section class="mb-4 content-panel">
      <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
        <div>
          <h2 class="h4 mb-1">Chapter 2: Explore secondary causes</h2>
          <p class="mb-0 text-muted">ICD-10 chapters are aligned to the 113 underlying cause list; hover to see how secondary causes rise and fall week by week.</p>
        </div>
        <span class="badge bg-warning-subtle text-warning fw-semibold">Trend</span>
      </div>
      <div id="timeSeries" class="chart"></div>
    </section>

    <!-- Chapter 3 -->
    <section class="mb-4 content-panel">
      <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
        <div>
          <h2 class="h4 mb-1">Chapter 3: Urban footprint</h2>
          <p class="mb-0 text-muted">Which urbanization tiers carry the burden for a cause? Drill down with the sunburst.</p>
        </div>
        <span class="badge bg-info-subtle text-info fw-semibold">Structure</span>
      </div>
      <div id="urban-deaths" class="chart mt-2"></div>
    </section>

    <!-- Urban Trends Section -->
    <section class="mb-5">
      <div class="section trends" data-anchor="trends">
        <div class="slide trends-intro bg-image">
          <div class="bg-opacity">
            <div class="intro-para">
              <h2 class="text-red">Chapter 4: Age and where deaths occur</h2>
              <h5>
                Track how urban deaths shift between 2018 and 2025. Swap the grouping to compare sex, race, urbanization level, cause chapters, ten-year age bands, or where people pass away - inpatient floors, homes, hospice, or nursing facilities.
              </h5>
            </div>
          </div>
          <div class="center-page"><span></span>Scroll</div>
        </div>

        <div class="slide trends-viz">
          <div id="trends-container" class="section-container">

            <div class="section-intro">
              <h1>Urban mortality pathways</h1>
              <h5>
                This stacked view shows how deaths distribute by urban tier, demographic, age band, cause, and place of deathâ€”revealing who is most affected and where life ends.
                <br><span class="text-em">Swap the grouping on the left; click any layer to isolate its trajectory.</span></br>
              </h5>
            </div>
            <div id="trends-wrapper" class="viz-wrapper">

              <!-- Buttons -->
              <div id="filter-buttons" class="viz-filter-buttons">
                <button type="button" id="gender-button">Gender</button>
                <button type="button" id="urban-button">Urbanization</button>
                <button type="button" id="ethnicity-button">Ethnicity</button>
                <button type="button" id="cause-button">Cause</button>
                <button type="button" id="age-button">Age</button>
                <button type="button" id="place-death-button">Place of Death</button>
                <button type="button" id="total-button">Total</button>
              </div>

              <!--Main Viz Wrap-->
              <div id="stack-chart-content" class="viz-content">
                  <svg class="stack-chart-svg"></svg>
                  <div id="stack-legend">
                      <div class="title">Legend</div>
                      <div class="legend-items"></div>
                  </div>
                  <div class="focus-chart">
                      <div class="focus-chart-header">Group Focus</div>
                      <svg class="focus-chart-svg"></svg>
                      <div class="focus-chart-empty">Click a layer to view its individual trend line.</div>
                  </div>
              </div>

              <!--Text-->
              <div id="trends-insights-wrapper" class="insights-wrapper">
                <h2 id="trends-insights-header" class="insights-header">Key Insights</h2>
                <div id="trends-text" class="insights-text"></div>
                <button type="button" id="trends-next" class="insights-next">Next</button>
              </div>

            </div>

          </div>
          <div class="scroll-down"><span></span>Scroll</div>
        </div>

      </div>
    </section>

    <!-- Data & Usage Notes -->
    <section class="mb-4 content-panel">
      <h2 class="h4">Methods & reuse notes</h2>
      <ul class="mb-1">
        <li><strong>Recommended export:</strong> CDC WONDER provisional multiple cause of death by week or month with year, state, ICD-10 cause, race, age-group, urbanization, deaths, population.</li>
        <li><strong>Preprocessing:</strong> compute crude rates per 100,000 (deaths / population * 100000). For comparisons over time, consider age-adjustment using a standard population.</li>
        <li><strong>Age & place-of-death view:</strong> uses ten-year age bands and place-of-death categories from <code>ageLocation.csv</code>.</li>
        <li><strong>To use your own CSV:</strong> ensure column names like <code>year</code>, <code>state</code>, <code>cause</code>, <code>race</code>, <code>urbanization</code>, <code>deaths</code>, and <code>population</code>.</li>
      </ul>
    </section>

    <!-- Footer -->
    <footer class="mt-4 mb-5 border-top pt-3">
      <small>Created by Khaleesi Chen - Exploring CDC provisional mortality data (2018-2025).</small>
    </footer>
  </div>

  <!-- Load topojson-client (used by choropleth) and site scripts -->
  <script src="https://unpkg.com/topojson-client@3/dist/topojson-client.min.js"></script>
  <script src="js/data-loader.js"></script>
  <script src="js/ucd-mcd-charts.js"></script>
  <script src="js/choropleth.js"></script>
  <script src="js/deaths-sunburst.js"></script>
  <script src="js/urban-trends.js"></script>
  <script>
    // Initialize page: load remote datasets and render modules
    (async function () {
      try {
        const data = await window.loadMortalityData();

        // Render UCD/MCD interactive chart (uses the Cause CSV)
        renderUcdMcd('#timeSeries', data.Cause);

        const ALL_CAUSES = 'All causes';
        const ALL_RACES = 'All races';
        const ALL_SEXES = 'All sexes';

        // Helper to get unique, sorted values for dropdowns
        function getUniqueSorted(arr, key) {
          return Array.from(new Set(arr.map(d => d[key]).filter(Boolean))).sort();
        }

        // Populate dropdowns
        function populateDropdown(id, values) {
          const sel = document.getElementById(id);
          if (!sel) return;
          sel.innerHTML = '';
          values.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v;
            opt.textContent = v;
            sel.appendChild(opt);
          });
        }

        // Populate all dropdowns from data, filtering out unwanted cause label
        const causes = [ALL_CAUSES].concat(getUniqueSorted(data.deathData, 'cause').filter(c => c && !c.includes('Data not shown due to 6 month lag')));
        const races = [ALL_RACES].concat(getUniqueSorted(data.deathData, 'race'));
        const sexes = [ALL_SEXES].concat(getUniqueSorted(data.deathData, 'sex'));
        populateDropdown('causeSelect', causes);
        populateDropdown('raceSelect', races);
        populateDropdown('sexSelect', sexes);

        // Set default cause to first available if present
        if (causes.length && !document.getElementById('causeSelect').value)
          document.getElementById('causeSelect').value = causes[0];

        // Render choropleth using normalized deathData and wire controls
        function computeCrudeRate(deaths, population) {
          if (!population) return NaN;
          return (deaths / population) * 100000;
        }

        function aggregateByState(rows, meta = {}) {
          const grouped = d3.group(rows, d => d.stateFips);
          return Array.from(grouped, ([stateFips, stateRows]) => {
            const deaths = d3.sum(stateRows, d => d.deaths || 0);
            const population = d3.sum(stateRows, d => d.population || 0);
            return {
              state: stateRows[0]?.state,
              stateFips,
              cause: meta.cause || null,
              race: meta.race || null,
              sex: meta.sex || null,
              deaths,
              population,
              rate: computeCrudeRate(deaths, population)
            };
          }).filter(d => d.stateFips);
        }

        function renderMapFromControls(localDeathData) {
          const cause = document.getElementById('causeSelect').value;
          const race = document.getElementById('raceSelect').value;
          const sex = document.getElementById('sexSelect').value;

          // Determine dataset based on selections
          let dataset = [];
          if (cause === ALL_CAUSES) {
            dataset = data.stateTotals;
          } else if (race === ALL_RACES && sex === ALL_SEXES) {
            dataset = (data.causeTotalsByState || []).filter(d => d.cause === cause);
            if (!dataset.length) {
              const base = (localDeathData || data.deathData).filter(d => d.cause === cause);
              dataset = aggregateByState(base, { cause });
            }
          } else {
            const base = (localDeathData || data.deathData).filter(d =>
              d.cause === cause &&
              (race === ALL_RACES || d.race === race) &&
              (sex === ALL_SEXES || d.sex === sex)
            );
            dataset = aggregateByState(base, {
              cause,
              race: race === ALL_RACES ? null : race,
              sex: sex === ALL_SEXES ? null : sex
            });
          }

          const causeFilter = cause === ALL_CAUSES ? null : cause;
          const raceFilter = race === ALL_RACES ? null : race;
          const sexFilter = sex === ALL_SEXES ? null : sex;

          renderChoropleth('#choropleth', dataset, data.us, {
            cause: causeFilter,
            causeLabel: cause,
            race: raceFilter,
            sex: sexFilter
          });
        }

        renderMapFromControls();

        // Re-render map when selectors change
        ['causeSelect','raceSelect','sexSelect'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.addEventListener('change', () => renderMapFromControls());
        });

        // Summary cards
        document.getElementById('total-deaths').textContent = d3.format(',')(d3.sum(data.deathData, d => d.deaths));
        document.getElementById('unique-causes').textContent = d3.format(',')(causes.length - 1); // exclude "All causes"
        document.getElementById('unique-races').textContent = d3.format(',')(races.length - 1); // exclude "All races"
        document.getElementById('unique-sexes').textContent = d3.format(',')(sexes.length - 1); // exclude "All sexes"

        // Pie chart for deaths by sex
        const pieData = Array.from(d3.rollup(data.deathData, v => d3.sum(v, d => d.deaths), d => d.sex), ([sex, deaths]) => ({ sex, deaths }));
        const width = 320, height = 320, radius = Math.min(width, height) / 2;
        const color = d3.scaleOrdinal().domain(pieData.map(d => d.sex)).range(["#4e79a7", "#f28e2b", "#e15759"]);
        const svg = d3.select('#sex-pie-chart').append('svg').attr('width', width).attr('height', height);
        const g = svg.append('g').attr('transform', `translate(${width/2},${height/2})`);
        const pie = d3.pie().value(d => d.deaths);
        const arc = d3.arc().innerRadius(60).outerRadius(radius - 10);
        const arcs = g.selectAll('arc').data(pie(pieData)).enter().append('g');
        arcs.append('path')
            .attr('d', arc)
            .attr('fill', d => color(d.data.sex))
            .attr('stroke', '#fff')
            .attr('stroke-width', 2)
            .on('mouseover', function(event, d) {
                d3.select(this).attr('opacity', 0.7);
            })
            .on('mouseout', function(event, d) {
                d3.select(this).attr('opacity', 1);
            });
        arcs.append('text')
            .attr('transform', d => `translate(${arc.centroid(d)})`)
            .attr('text-anchor', 'middle')
            .attr('dy', '0.35em')
            .style('font-size', '1.1rem')
            .style('font-weight', '600')
            .text(d => d.data.sex);

        // Initialize Urban deaths sunburst (loads ../Data/Urban.csv)
        let urbanRows = null;
        try {
          urbanRows = await window.renderUrbanDeaths('#urban-deaths');
        } catch (err) {
          console.warn('Urban deaths viz not initialized:', err && err.message ? err.message : err);
        }

        if (window.renderUrbanTrends) {
          try {
            await window.renderUrbanTrends('#trends-container', urbanRows || []);
          } catch (err) {
            console.warn('Urban trends viz not initialized:', err && err.message ? err.message : err);
          }
        }

      } catch (err) {
        console.error('Error initializing visualizations', err);
        const msg = err && err.message ? err.message : String(err);
        alert('Failed to load remote datasets: ' + msg);
      }
    })();
  </script>
</body>
</html>


