<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Visualizing Mortality Patterns in the U.S. (2018–2024)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-2.24.2.min.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .hero { padding: 28px 0; }
    .controls { gap: 12px; display: flex; flex-wrap: wrap; align-items: center; }
    .chart { min-height: 360px; margin-bottom: 24px; }
    @media (max-width: 768px) { .controls { flex-direction: column; align-items: stretch; } }
    .note { font-size: 0.9rem; color: #444; }
  </style>
</head>
<body>
  <div class="container py-4">
    <header class="hero">
      <h1>Visualizing Mortality Patterns in the U.S.: Trends by Cause, Demographics, and Urbanization (2018–2024)</h1>
      <p class="mb-1"><strong>Group Member:</strong> Khaleesi Chen</p>
      <p class="lead">Understanding how mortality patterns differ across regions, races, and causes of death offers essential insights into public health disparities and emerging threats. This site demonstrates interactive, multi-level visualizations built from CDC WONDER provisional mortality data.</p>
    </header>

    <section class="mb-4">
      <h3>Project Goal</h3>
      <p>Explore questions like: How have mortality rates from key causes (COVID-19, heart disease, drug overdoses) changed since 2018? How do trends vary by race, age, geography, and urbanization?</p>
    </section>

    <section class="mb-4">
      <h4>Dataset</h4>
      <p class="note">This page is a demo. To load real data, export CDC WONDER's Provisional Multiple Cause of Death dataset (CSV) and place it at <code>data/provisional_deaths.csv</code>. See the <strong>Data & usage</strong> notes below for preprocessing tips.</p>
    </section>

    <section class="mb-3">
      <div class="controls mb-2">
        <label class="me-2"><strong>Cause:</strong>
          <select id="causeSelect" class="form-select d-inline-block" style="width:220px">
            <option>COVID-19</option>
            <option>Heart disease</option>
            <option>Drug overdoses</option>
          </select>
        </label>

        <label class="me-2"><strong>Years:</strong>
          <input id="yearStart" type="number" value="2018" min="2018" max="2024" class="form-control d-inline-block" style="width:96px"> -
          <input id="yearEnd" type="number" value="2024" min="2018" max="2024" class="form-control d-inline-block" style="width:96px">
        </label>

        <label class="me-2"><strong>Urbanization:</strong>
          <select id="urbanSelect" class="form-select d-inline-block" style="width:220px">
            <option value="all">All</option>
            <option value="large">Large Metro</option>
            <option value="medium">Medium/Small Metro</option>
            <option value="nonmetro">Nonmetro</option>
          </select>
        </label>

        <button id="loadCSV" class="btn btn-outline-secondary">Load Local CSV</button>
      </div>
      <div class="note mt-2">Add your CDC WONDER export file to <code>data/provisional_deaths.csv</code> and click <strong>Load Local CSV</strong> (serve the folder with a local webserver to avoid CORS).</div>
    </section>

    <section>
      <div id="timeSeries" class="chart"></div>
      <div id="choropleth" class="chart"></div>
    </section>

    <section class="mt-3">
      <h4>Data & usage</h4>
      <ul>
        <li>Recommended export: CDC WONDER provisional multiple cause of death by week/month, with columns for year, state, county, ICD-10 cause, race, age-group, urbanization, deaths, population.</li>
        <li>Preprocessing: compute rates per 100,000 (deaths / population * 100000). For comparisons over time, consider age-adjustment using a standard population.</li>
        <li>To use your own CSV: ensure column names like <code>year</code>, <code>state</code> (2-letter), <code>cause</code>, <code>race</code>, <code>urbanization</code>, <code>deaths</code>, and <code>population</code>.</li>
      </ul>
    </section>

    <footer class="mt-4 mb-5">
      <small>Created by Khaleesi Chen — Demo for exploring CDC provisional mortality data (2018–2024).</small>
    </footer>
  </div>

  <!-- Load topojson-client (used by choropleth) and site scripts -->
  <script src="https://unpkg.com/topojson-client@3/dist/topojson-client.min.js"></script>
  <script src="js/data-loader.js"></script>
  <script src="js/ucd-mcd-charts.js"></script>
  <script src="js/choropleth.js"></script>
  <script>
    // Initialize page: load remote datasets and render modules
    (async function () {
      try {
        const data = await window.loadMortalityData();

        // Render UCD/MCD interactive chart (uses the Cause CSV)
        // The user's `Cause` CSV is passed directly
        renderUcdMcd('#timeSeries', data.Cause);

        // Render choropleth using normalized deathData and wire controls
        function renderMapFromControls(localDeathData) {
          const cause = document.getElementById('causeSelect').value || null;
          const race = null;
          const sex = null;
          const ddata = localDeathData || data.deathData;
          renderChoropleth('#choropleth', ddata, data.us, { cause, race, sex });
        }

        renderMapFromControls();

        // Re-render map when selectors change
        ['causeSelect','yearStart','yearEnd','urbanSelect'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.addEventListener('change', () => renderMapFromControls());
        });

        // Wire CSV button to re-run renderers using a local CSV if desired
        document.getElementById('loadCSV').addEventListener('click', async () => {
          const path = 'data/provisional_deaths.csv';
          try {
            const rows = await d3.csv(path);
            renderUcdMcd('#timeSeries', rows);
            const norm = rows.map(r => ({
              state: r['Residence State'] || r.state,
              stateFips: (r['Residence State Code'] || r.stateFips || '').toString().padStart(2, '0'),
              race: r['Single Race 6'] || r.race,
              sex: r['Sex'] || r.sex,
              cause: r['UCD - ICD Chapter'] || r.cause,
              deaths: +r.Deaths || +r.deaths || 0,
              population: +r.Population || +r.population || 0,
              rate: (() => { const rr = (r['Crude Rate'] || r.rate || '').toString().trim(); return rr === '' || rr.toLowerCase() === 'unreliable' ? NaN : +rr; })()
            }));
            renderMapFromControls(norm);
          } catch (err) {
            alert('Could not load CSV at "' + path + '". Place your CDC WONDER export at that path and serve the site from a local webserver.');
          }
        });

      } catch (err) {
        console.error('Error initializing visualizations', err);
        const msg = err && err.message ? err.message : String(err);
        alert('Failed to load remote datasets: ' + msg + '\n\nIf this persists, check the raw URLs in js/data-loader.js and try opening them in your browser (ensure network access and that GitHub raw URLs are reachable).');
      }
    })();
  </script>
</body>
</html>
