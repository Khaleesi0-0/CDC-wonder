<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Visualizing Mortality Patterns in the U.S. (2018–2024)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-2.24.2.min.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .hero { padding: 28px 0; }
    .controls { gap: 12px; display: flex; flex-wrap: wrap; align-items: center; }
    .chart { min-height: 360px; margin-bottom: 24px; }
    @media (max-width: 768px) { .controls { flex-direction: column; align-items: stretch; } }
    .note { font-size: 0.9rem; color: #444; }
  </style>
</head>
<body>
  <div class="container py-4">
    <!-- Header -->
    <header class="hero mb-4">
      <h1 class="mb-2">Visualizing Mortality Patterns in the U.S.<br><small class="text-muted">Trends by Cause, Demographics, and Urbanization (2018–2024)</small></h1>
      <p class="mb-1"><strong>Group Member:</strong> Khaleesi Chen</p>
      <p class="lead">Understanding how mortality patterns differ across regions, races, and causes of death offers essential insights into public health disparities and emerging threats. This site presents interactive, multi-level visualizations built from CDC WONDER provisional mortality data.</p>
    </header>

    <!-- Project Goal -->
    <section class="mb-4">
      <h2 class="h4">Project Goal</h2>
      <p>Explore questions like: <strong>How have mortality rates from key causes (COVID-19, heart disease, drug overdoses) changed since 2018?</strong> How do trends vary by race, age, geography, and urbanization?</p>
    </section>

    <!-- Dataset Info -->
    <section class="mb-4">
      <h2 class="h4">Dataset</h2>
      <p class="note">To load your own data, export CDC WONDER's Provisional Multiple Cause of Death dataset (CSV) and place it at <code>data/provisional_deaths.csv</code>.<br>See the <strong>Data & usage</strong> notes below for preprocessing tips.</p>
    </section>

    <!-- Controls -->
    <section class="mb-4">
      <h2 class="h4 mb-3">Interactive Controls</h2>
      <div class="controls mb-2">
        <label class="me-2"><strong>Cause:</strong>
          <select id="causeSelect" class="form-select d-inline-block" style="width:220px"></select>
        </label>
        <label class="me-2"><strong>Race:</strong>
          <select id="raceSelect" class="form-select d-inline-block" style="width:180px"></select>
        </label>
        <label class="me-2"><strong>Sex:</strong>
          <select id="sexSelect" class="form-select d-inline-block" style="width:140px"></select>
        </label>
      </div>
      <!-- Note removed with CSV/Year controls -->
    </section>

    <!-- Map and Visualizations -->
    <section class="mb-4">
      <h2 class="h4 mb-3">Visualizations</h2>
      <!-- Move map directly under controls -->
      <div id="choropleth" class="chart mb-4"></div>
      <div id="timeSeries" class="chart"></div>
    </section>

    <!-- Data & Usage Notes -->
    <section class="mb-4">
      <h2 class="h4">Data & Usage</h2>
      <ul>
        <li><strong>Recommended export:</strong> CDC WONDER provisional multiple cause of death by week/month, with columns for year, state, county, ICD-10 cause, race, age-group, urbanization, deaths, population.</li>
        <li><strong>Preprocessing:</strong> compute rates per 100,000 (deaths / population * 100000). For comparisons over time, consider age-adjustment using a standard population.</li>
        <li><strong>To use your own CSV:</strong> ensure column names like <code>year</code>, <code>state</code> (2-letter), <code>cause</code>, <code>race</code>, <code>urbanization</code>, <code>deaths</code>, and <code>population</code>.</li>
      </ul>
    </section>

    <!-- Footer -->
    <footer class="mt-4 mb-5 border-top pt-3">
      <small>Created by Khaleesi Chen — Exploring CDC provisional mortality data (2018–2024).</small>
    </footer>
  </div>

  <!-- Load topojson-client (used by choropleth) and site scripts -->
  <script src="https://unpkg.com/topojson-client@3/dist/topojson-client.min.js"></script>
  <script src="js/data-loader.js"></script>
  <script src="js/ucd-mcd-charts.js"></script>
  <script src="js/choropleth.js"></script>
  <script>
    // Initialize page: load remote datasets and render modules
    (async function () {
      try {
        const data = await window.loadMortalityData();

        // Render UCD/MCD interactive chart (uses the Cause CSV)
        renderUcdMcd('#timeSeries', data.Cause);

        // Helper to get unique, sorted values for dropdowns
        function getUniqueSorted(arr, key) {
          return Array.from(new Set(arr.map(d => d[key]).filter(Boolean))).sort();
        }

        // Populate dropdowns
        function populateDropdown(id, values) {
          const sel = document.getElementById(id);
          if (!sel) return;
          // Remove all except first ("All")
          while (sel.options.length > 1) sel.remove(1);
          values.forEach(v => {
            const opt = document.createElement('option');
            opt.value = v;
            opt.textContent = v;
            sel.appendChild(opt);
          });
        }

        // Populate all dropdowns from data, filtering out unwanted cause label
        const causes = getUniqueSorted(data.deathData, 'cause').filter(c => c && !c.includes('Data not shown due to 6 month lag'));
        const races = getUniqueSorted(data.deathData, 'race');
        const sexes = getUniqueSorted(data.deathData, 'sex');
        populateDropdown('causeSelect', causes);
        populateDropdown('raceSelect', races);
        populateDropdown('sexSelect', sexes);

        // Set default cause to first available if present
        if (causes.length && !document.getElementById('causeSelect').value)
          document.getElementById('causeSelect').value = causes[0];

        // Render choropleth using normalized deathData and wire controls
        function renderMapFromControls(localDeathData) {
          const cause = document.getElementById('causeSelect').value;
          const race = document.getElementById('raceSelect').value;
          const sex = document.getElementById('sexSelect').value;
          const ddata = localDeathData || data.deathData;
          // Only filter if not "All" (empty string)
          const filtered = ddata.filter(d =>
            (!cause || d.cause === cause) &&
            (!race || d.race === race) &&
            (!sex || d.sex === sex)
          );
          renderChoropleth('#choropleth', filtered, data.us, { cause, race, sex });
        }

        renderMapFromControls();

        // Re-render map when selectors change
        ['causeSelect','raceSelect','sexSelect','yearStart','yearEnd'].forEach(id => {
          const el = document.getElementById(id);
          if (el) el.addEventListener('change', () => renderMapFromControls());
        });

        // Wire CSV button to re-run renderers using a local CSV if desired
        document.getElementById('loadCSV').addEventListener('click', async () => {
          const path = 'data/provisional_deaths.csv';
          try {
            const rows = await d3.csv(path);
            renderUcdMcd('#timeSeries', rows);
            const norm = rows.map(r => ({
              state: r['Residence State'] || r.state,
              stateFips: (r['Residence State Code'] || r.stateFips || '').toString().padStart(2, '0'),
              race: r['Single Race 6'] || r.race,
              sex: r['Sex'] || r.sex,
              cause: r['UCD - ICD Chapter'] || r.cause,
              deaths: +r.Deaths || +r.deaths || 0,
              population: +r.Population || +r.population || 0,
              rate: (() => { const rr = (r['Crude Rate'] || r.rate || '').toString().trim(); return rr === '' || rr.toLowerCase() === 'unreliable' ? NaN : +rr; })()
            }));
            // Repopulate dropdowns with new data
            populateDropdown('causeSelect', getUniqueSorted(norm, 'cause').filter(c => c && !c.includes('Data not shown due to 6 month lag')));
            populateDropdown('raceSelect', getUniqueSorted(norm, 'race'));
            populateDropdown('sexSelect', getUniqueSorted(norm, 'sex'));
            renderMapFromControls(norm);
          } catch (err) {
            alert('Could not load CSV at "' + path + '". Place your CDC WONDER export at that path and serve the site from a local webserver.');
          }
        });

      } catch (err) {
        console.error('Error initializing visualizations', err);
        const msg = err && err.message ? err.message : String(err);
        alert('Failed to load remote datasets: ' + msg + '\n\nIf this persists, check the raw URLs in js/data-loader.js and try opening them in your browser (ensure network access and that GitHub raw URLs are reachable).');
      }
    })();
  </script>
</body>
</html>
